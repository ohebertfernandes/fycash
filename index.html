<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FluxoCash | Planejamento Pro</title>
    
    <!-- Bibliotecas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; overflow: hidden; }
        
        /* TELA DE LOGIN */
        #auth-screen { background: linear-gradient(135deg, #065f46 0%, #047857 100%); z-index: 50; }
        .glass-panel { background: rgba(255, 255, 255, 0.98); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }

        /* NAVEGA√á√ÉO */
        .nav-item { color: #64748b; transition: all 0.2s; border-bottom: 3px solid transparent; font-weight: 600; }
        .nav-item:hover { color: #059669; }
        .nav-item.active { color: #059669; border-bottom-color: #059669; }
        .mob-item { color: #94a3b8; }
        .mob-item.active { color: #059669; transform: translateY(-2px); }

        /* Progress Bar Animation */
        .progress-bar { transition: width 1s ease-in-out; }

        /* UTILIT√ÅRIOS */
        .flex { display: flex !important; }
        .hidden { display: none !important; }
        .loading-btn { opacity: 0.7; cursor: wait; }
        .card { background: white; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* MODAIS */
        .modal-overlay { z-index: 9999; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="h-screen flex flex-col text-slate-800">

    <!-- LOGIN -->
    <div id="auth-screen" class="fixed inset-0 flex items-center justify-center p-4 transition-all duration-500">
        <div class="glass-panel w-full max-w-md p-8 rounded-2xl relative text-center">
            <div class="mb-6 inline-block p-4 bg-emerald-100 rounded-full text-emerald-600 text-4xl shadow-lg"><i class="fa-solid fa-chart-line"></i></div>
            <h1 class="text-3xl font-bold text-slate-800 mb-2">FluxoCash Pro</h1>
            <p class="text-slate-500 text-sm mb-6">Planejamento Financeiro & Intelig√™ncia</p>
            <div id="status-badge" class="hidden mt-2 inline-block bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full font-bold">Offline</div>
            
            <div id="view-login">
                <form id="form-login" class="space-y-4">
                    <input type="email" id="log-email" class="w-full p-3 border rounded-xl outline-none" placeholder="E-mail" required>
                    <input type="password" id="log-pass" class="w-full p-3 border rounded-xl outline-none" placeholder="Senha" required>
                    <button type="submit" id="btn-login" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-700 shadow-lg">ACESSAR PAINEL</button>
                </form>
                <div class="mt-4 text-sm text-slate-500">Novo? <button onclick="toggleAuth('register')" class="text-emerald-600 font-bold hover:underline">Criar conta</button></div>
            </div>

            <div id="view-register" class="hidden">
                <form id="form-register" class="space-y-4">
                    <input type="email" id="reg-email" class="w-full p-3 border rounded-xl" placeholder="E-mail" required>
                    <input type="password" id="reg-pass" class="w-full p-3 border rounded-xl" placeholder="Senha (min 6)" required minlength="6">
                    <input type="password" id="reg-confirm" class="w-full p-3 border rounded-xl" placeholder="Confirmar" required>
                    <button type="submit" id="btn-reg" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-700">REGISTRAR</button>
                </form>
                <div class="mt-4 text-sm text-slate-500">J√° tem conta? <button onclick="toggleAuth('login')" class="text-emerald-600 font-bold hover:underline">Login</button></div>
            </div>

            <div class="mt-6 pt-4 border-t border-slate-200">
                <button onclick="forceOfflineMode()" class="text-xs text-slate-400 font-bold hover:text-emerald-600 uppercase tracking-wide w-full">
                    <i class="fa-solid fa-wifi-slash"></i> Modo Offline (Demo)
                </button>
            </div>
            <p id="auth-error" class="text-red-500 text-xs mt-3 font-bold h-4"></p>
        </div>
    </div>

    <!-- APP -->
    <div id="app-screen" class="hidden flex-col h-full w-full">
        <header class="bg-white border-b border-slate-200 z-30 flex-none shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-2">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-chart-pie text-emerald-600 text-xl"></i>
                        <span class="font-bold text-slate-800 text-lg">FluxoCash</span>
                        <span id="mode-badge" class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full font-bold ml-1">...</span>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <button onclick="openFeedback()" class="text-slate-400 hover:text-emerald-600 text-sm font-bold flex items-center gap-1" title="Sugest√£o"><i class="fa-solid fa-box-open"></i> <span class="hidden sm:inline">Sugest√µes</span></button>
                        <button onclick="openAdmin()" id="btn-admin" class="hidden text-slate-800 hover:text-emerald-600 relative"><i class="fa-solid fa-lock"></i> ADM <span id="admin-badge" class="absolute -top-2 -right-2 bg-red-500 w-4 h-4 rounded-full flex items-center justify-center text-[9px] text-white hidden">0</span></button>
                        <div class="h-4 w-px bg-slate-300"></div>
                        <span id="user-label" class="text-xs text-slate-400 hidden sm:block">...</span>
                        <button onclick="doLogout()" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-power-off"></i></button>
                    </div>
                </div>
            </div>

            <!-- TABS -->
            <div class="bg-slate-50 border-t border-slate-200">
                <nav class="max-w-7xl mx-auto px-4 flex space-x-6 overflow-x-auto justify-center">
                    <button onclick="nav('dashboard')" class="nav-item active py-3 text-xs uppercase tracking-widest" id="nav-d-dashboard">Geral</button>
                    <button onclick="nav('budget')" class="nav-item py-3 text-xs uppercase tracking-widest" id="nav-d-budget">Or√ßamento</button>
                    <button onclick="nav('variable')" class="nav-item py-3 text-xs uppercase tracking-widest" id="nav-d-variable">Lan√ßamentos</button>
                    <button onclick="nav('fixed')" class="nav-item py-3 text-xs uppercase tracking-widest" id="nav-d-fixed">Fixas</button>
                    <button onclick="nav('debts')" class="nav-item py-3 text-xs uppercase tracking-widest" id="nav-d-debts">Passivos</button>
                    <button onclick="nav('goals')" class="nav-item py-3 text-xs uppercase tracking-widest" id="nav-d-goals">Metas</button>
                </nav>
            </div>
        </header>

        <main class="flex-grow overflow-y-auto p-4 pb-24 scroll-smooth bg-slate-50">
            <div class="max-w-6xl mx-auto space-y-6">

                <!-- 1. GERAL (DASHBOARD) -->
                <div id="page-dashboard" class="space-y-6 animate-fade-in">
                    
                    <!-- Resumo R√°pido -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="card p-4"><p class="text-[10px] text-slate-400 font-bold uppercase">Receita (M√™s)</p><p id="dash-income" class="text-xl font-bold text-emerald-600">R$ 0</p></div>
                        <div class="card p-4"><p class="text-[10px] text-slate-400 font-bold uppercase">Despesas (M√™s)</p><p id="dash-expense" class="text-xl font-bold text-red-600">R$ 0</p></div>
                        <div class="card p-4"><p class="text-[10px] text-slate-400 font-bold uppercase">Investido (Total)</p><p id="dash-invest" class="text-xl font-bold text-blue-600">R$ 0</p></div>
                        <div class="card p-4 bg-slate-800 text-white border-none"><p class="text-[10px] text-slate-400 font-bold uppercase">Saldo Acumulado</p><p id="dash-balance" class="text-xl font-bold text-emerald-400">R$ 0</p></div>
                    </div>

                    <!-- üÜï GEST√ÉO DE RECEITAS -->
                    <div class="card p-6 border-l-4 border-l-emerald-500">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-money-bill-trend-up text-emerald-500"></i> Entradas & Receitas</h2>
                            <div class="flex gap-2">
                                <button onclick="resetAll()" class="text-xs text-slate-300 hover:text-red-500 px-2">Resetar</button>
                            </div>
                        </div>

                        <form onsubmit="addIncome(event)" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4 bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                            <input id="inc-desc" type="text" placeholder="Descri√ß√£o (Ex: Sal√°rio)" class="p-2 border rounded text-sm outline-none bg-white" required>
                            
                            <!-- Input com Datalist para Origem -->
                            <div>
                                <input list="origins-list" id="inc-origin" type="text" placeholder="Origem (Ex: Freelance)" class="w-full p-2 border rounded text-sm outline-none bg-white" required autocomplete="off">
                                <datalist id="origins-list">
                                    <!-- Populated via JS -->
                                </datalist>
                            </div>

                            <input id="inc-val" type="number" placeholder="Valor (R$)" class="p-2 border rounded text-sm outline-none bg-white font-bold text-emerald-700" step="0.01" required>
                            <input id="inc-date" type="date" class="p-2 border rounded text-sm outline-none bg-white" required>
                            
                            <button class="bg-emerald-600 text-white font-bold p-2 rounded text-sm col-span-2 md:col-span-4 hover:bg-emerald-700 shadow transition">
                                <i class="fa-solid fa-plus-circle mr-1"></i> Lan√ßar Receita
                            </button>
                        </form>

                        <!-- Lista de Receitas do M√™s -->
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 text-slate-500 text-xs uppercase">
                                    <tr>
                                        <th class="p-2">Data</th>
                                        <th class="p-2">Descri√ß√£o</th>
                                        <th class="p-2">Origem</th>
                                        <th class="p-2 text-right">Valor</th>
                                        <th class="w-8"></th>
                                    </tr>
                                </thead>
                                <tbody id="list-incomes-month" class="divide-y divide-slate-100">
                                    <!-- Injected JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Meta em Foco -->
                    <div class="card p-4 relative bg-white">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-slate-600 uppercase text-xs tracking-wide">üéØ Meta em Foco</h3>
                            <div class="flex gap-2">
                                <button onclick="prevGoal()" class="text-slate-400 hover:text-emerald-600"><i class="fa-solid fa-chevron-left"></i></button>
                                <span id="goal-counter" class="text-xs text-slate-400">0/0</span>
                                <button onclick="nextGoal()" class="text-slate-400 hover:text-emerald-600"><i class="fa-solid fa-chevron-right"></i></button>
                            </div>
                        </div>
                        <div id="goal-display-area" class="text-center py-2">
                            <h2 class="text-2xl font-bold text-slate-800" id="dash-goal-name">Nenhuma Meta</h2>
                            <p class="text-sm text-slate-500 mb-2">Faltam <span id="dash-goal-missing" class="font-bold text-red-500">R$ 0,00</span></p>
                            <div class="w-full bg-slate-200 rounded-full h-4 mb-1">
                                <div id="dash-goal-bar" class="bg-emerald-500 h-4 rounded-full transition-all duration-1000" style="width: 0%"></div>
                            </div>
                            <p class="text-xs text-slate-400" id="dash-goal-pct">0% Conclu√≠do</p>
                        </div>
                    </div>

                    <!-- Gr√°ficos Grid -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- Receitas -->
                        <div class="card p-5 h-80">
                            <h3 class="font-bold text-slate-700 mb-4 text-xs uppercase flex justify-between"><span>üìà Receitas Anuais & Origem</span> <span class="text-emerald-500"><i class="fa-solid fa-arrow-trend-up"></i></span></h3>
                            <div class="relative h-60 w-full"><canvas id="chart-revenue"></canvas></div>
                        </div>
                        
                        <!-- Despesas -->
                        <div class="card p-5 h-80">
                            <h3 class="font-bold text-slate-700 mb-4 text-xs uppercase flex justify-between"><span>üìâ Fixas vs Vari√°veis (Ano)</span> <span class="text-red-500"><i class="fa-solid fa-arrow-trend-down"></i></span></h3>
                            <div class="relative h-60 w-full"><canvas id="chart-expenses"></canvas></div>
                        </div>

                        <!-- Gargalos -->
                        <div class="card p-5 h-80">
                            <h3 class="font-bold text-slate-700 mb-4 text-xs uppercase flex justify-between"><span>‚ö†Ô∏è Gargalos (Or√ßamento)</span> <i class="fa-solid fa-triangle-exclamation text-orange-500"></i></h3>
                            <div class="relative h-60 w-full"><canvas id="chart-bottlenecks"></canvas></div>
                        </div>

                        <!-- Saldo -->
                        <div class="card p-5 h-80">
                            <h3 class="font-bold text-slate-700 mb-4 text-xs uppercase flex justify-between"><span>üí∞ Evolu√ß√£o de Saldo</span> <i class="fa-solid fa-scale-balanced text-blue-500"></i></h3>
                            <div class="relative h-60 w-full"><canvas id="chart-balance"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- 2. OR√áAMENTO -->
                <div id="page-budget" class="hidden space-y-6 animate-fade-in">
                    <div class="bg-purple-50 p-6 rounded-2xl border border-purple-100 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h2 class="text-xl font-bold text-purple-900">Planejamento de Limites</h2>
                                <p class="text-sm text-purple-700">Defina quanto voc√™ quer gastar em cada √°rea.</p>
                            </div>
                            <button onclick="suggestBudget()" class="bg-purple-600 text-white px-3 py-2 rounded-lg text-xs font-bold shadow hover:bg-purple-700">Sugest√£o Pai Rico (50/30/20)</button>
                        </div>
                        <div id="budget-list" class="grid md:grid-cols-2 gap-4"></div>
                    </div>
                </div>

                <!-- 3. LAN√áAMENTOS (VARI√ÅVEIS) -->
                <div id="page-variable" class="hidden space-y-6 animate-fade-in">
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-slate-800">Novo Lan√ßamento (Despesa)</h2>
                            <label class="cursor-pointer text-slate-500 hover:text-emerald-600 text-xs font-bold flex items-center gap-1 border border-slate-200 px-2 py-1 rounded"><i class="fa-solid fa-file-import"></i> CSV <input type="file" class="hidden" onchange="importCSV(this)"></label>
                        </div>
                        
                        <form onsubmit="addVar(event)" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input id="var-desc" placeholder="T√≠tulo (Ex: Uber)" class="p-3 border rounded outline-none w-full" required>
                                <select id="var-cat" class="p-3 border rounded outline-none w-full">
                                    <option value="MORADIA">MORADIA</option>
                                    <option value="ALIMENTA√á√ÉO">ALIMENTA√á√ÉO</option>
                                    <option value="MERCADO">MERCADO</option>
                                    <option value="SAUDE">SA√öDE</option>
                                    <option value="LAZER">LAZER</option>
                                    <option value="VIAGENS">VIAGENS</option>
                                    <option value="COMPRAS">COMPRAS</option>
                                    <option value="PRESENTES">PRESENTES</option>
                                    <option value="OUTROS">OUTROS</option>
                                </select>
                                <input id="var-sub" placeholder="Subcategoria (Opcional)" class="p-3 border rounded outline-none w-full">
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 items-center">
                                <input id="var-val" type="number" placeholder="Valor (R$)" class="p-3 border rounded outline-none w-full font-bold text-red-600" step="0.01" required>
                                <input id="var-date" type="date" class="p-3 border rounded outline-none w-full" required>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-bold text-slate-500">Parcelas:</span>
                                    <input id="var-parc" type="number" value="1" min="1" max="60" class="p-3 border rounded outline-none w-20 text-center">
                                </div>
                                <button class="bg-slate-800 text-white font-bold p-3 rounded hover:bg-slate-900 w-full shadow-lg">LAN√áAR</button>
                            </div>
                        </form>
                    </div>

                    <div class="card p-6">
                        <h3 class="font-bold text-slate-600 text-sm uppercase mb-4 border-b pb-2">Hist√≥rico de Lan√ßamentos</h3>
                        <ul id="list-variable" class="divide-y text-sm max-h-96 overflow-y-auto"></ul>
                    </div>
                </div>

                <!-- 4. PASSIVOS -->
                <div id="page-debts" class="hidden space-y-6 animate-fade-in">
                    <div class="card p-6 border-l-4 border-l-red-500">
                        <div class="flex justify-between mb-4"><h2 class="text-lg font-bold text-slate-800">Financiamentos & Passivos</h2><button onclick="askAI('debts')" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded font-bold">An√°lise IA</button></div>
                        <form onsubmit="addDebt(event)" class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-6">
                            <input id="debt-name" placeholder="T√≠tulo (Ex: Carro)" class="p-3 border rounded md:col-span-2" required>
                            <input id="debt-tot" type="number" placeholder="Total Financiado" class="p-3 border rounded" step="0.01" required>
                            <input id="debt-rate" type="number" placeholder="Juros % a.m." class="p-3 border rounded" step="0.01">
                            <input id="debt-inst" type="number" placeholder="N¬∫ Parcelas" class="p-3 border rounded" required>
                            <button class="bg-red-600 text-white font-bold p-3 rounded hover:bg-red-700 md:col-span-5 mt-2">Registrar Financiamento</button>
                        </form>
                        <div id="list-debts" class="grid gap-3"></div>
                    </div>
                </div>

                <!-- 5. FIXAS -->
                <div id="page-fixed" class="hidden space-y-6 animate-fade-in">
                    <div class="card p-6">
                        <h2 class="text-lg font-bold text-slate-800 mb-4">Custos Fixos Mensais</h2>
                        <form onsubmit="addFixed(event)" class="flex gap-3 mb-6"><input id="fix-name" placeholder="Nome (Ex: Aluguel)" class="flex-grow p-3 border rounded outline-none" required><input id="fix-val" type="number" placeholder="Valor" class="w-32 p-3 border rounded outline-none" step="0.01" required><button class="bg-blue-600 text-white px-6 rounded font-bold hover:bg-blue-700">+</button></form>
                        <table class="w-full text-sm text-left"><thead class="bg-slate-50 text-slate-500"><tr><th class="p-3">Item</th><th class="p-3 text-right">Valor</th><th class="w-10"></th></tr></thead><tbody id="list-fixed" class="divide-y"></tbody></table>
                    </div>
                </div>

                <!-- 6. METAS -->
                <div id="page-goals" class="hidden space-y-6 animate-fade-in">
                    <div class="card p-6 border-l-4 border-l-emerald-500">
                        <div class="flex justify-between mb-4"><h2 class="font-bold text-slate-800 text-lg">Metas & Conquistas</h2><button onclick="askAI('goals')" class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded font-bold">Conselho</button></div>
                        <form onsubmit="addGoal(event)" class="flex gap-3 mb-6"><input id="goal-name" placeholder="Objetivo (ex: Viagem)" class="flex-grow p-3 border rounded outline-none" required><input id="goal-val" type="number" placeholder="Total (R$)" class="w-32 p-3 border rounded outline-none" step="0.01" required><input id="goal-date" type="date" class="p-3 border rounded outline-none" required><button class="bg-emerald-600 text-white px-5 rounded font-bold hover:bg-emerald-700">Criar</button></form>
                        <div id="list-goals-full" class="grid md:grid-cols-2 gap-4"></div>
                    </div>
                </div>

            </div>
        </main>

        <nav class="md:hidden flex-none bg-white border-t flex justify-around py-2 z-40 shadow-lg">
            <button onclick="nav('dashboard')" class="mob-item active flex flex-col items-center p-2" id="mob-dashboard"><i class="fa-solid fa-chart-pie text-xl mb-1"></i><span class="text-[10px]">Geral</span></button>
            <button onclick="nav('variable')" class="mob-item flex flex-col items-center p-2" id="mob-variable"><i class="fa-solid fa-list-check text-xl mb-1"></i><span class="text-[10px]">Lan√ßar</span></button>
            <button onclick="nav('budget')" class="mob-item flex flex-col items-center p-2" id="mob-budget"><i class="fa-solid fa-scale-balanced text-xl mb-1"></i><span class="text-[10px]">Or√ß</span></button>
            <button onclick="nav('debts')" class="mob-item flex flex-col items-center p-2" id="mob-debts"><i class="fa-solid fa-credit-card text-xl mb-1"></i><span class="text-[10px]">Pass</span></button>
            <button onclick="nav('goals')" class="mob-item flex flex-col items-center p-2" id="mob-goals"><i class="fa-solid fa-bullseye text-xl mb-1"></i><span class="text-[10px]">Metas</span></button>
        </nav>
    </div>

    <!-- MODALS -->
    <div id="feedback-modal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center p-4"><div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6"><h3 class="font-bold mb-2">Sugest√£o</h3><textarea id="feedback-text" class="w-full p-2 border rounded h-24"></textarea><div class="flex justify-end gap-2 mt-4"><button onclick="document.getElementById('feedback-modal').classList.add('hidden')" class="text-sm">Cancelar</button><button onclick="sendFeedback()" class="bg-emerald-600 text-white px-4 py-1 rounded font-bold">Enviar</button></div></div></div>
    <div id="admin-modal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center p-4"><div class="bg-white w-full max-w-2xl rounded shadow-2xl flex flex-col max-h-[80vh]"><div class="p-4 border-b flex justify-between font-bold"><span>Admin</span><button onclick="document.getElementById('admin-modal').classList.add('hidden')">x</button></div><div class="p-4 overflow-y-auto flex-grow bg-slate-50" id="admin-list"></div><div class="p-3 border-t text-right"><button onclick="loadAdminMessages()" class="text-blue-600 text-xs">Atualizar</button></div></div></div>
    <div id="ai-modal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center p-4"><div class="bg-white w-full max-w-lg rounded shadow-2xl flex flex-col max-h-[80vh]"><div class="p-4 border-b flex justify-between"><span class="font-bold text-indigo-600">Consultor IA</span><button onclick="document.getElementById('ai-modal').classList.add('hidden')">x</button></div><div id="ai-content" class="p-6 overflow-y-auto prose text-sm"></div></div></div>
    <!-- Modal Aporte -->
    <div id="aporte-modal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center p-4"><div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6"><h3 class="font-bold text-lg mb-4 text-emerald-800">Novo Aporte</h3><input type="number" id="aporte-val" class="w-full p-3 border rounded mb-4 text-xl font-bold" placeholder="R$ 0,00" step="0.01"><div class="flex justify-end gap-2"><button onclick="document.getElementById('aporte-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500">Cancelar</button><button onclick="confirmAporte()" class="px-4 py-2 bg-emerald-600 text-white rounded font-bold">Confirmar</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, getDocs, orderBy, query, updateDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCzz0ntyKDngm6Yae0OIbD0fXHakEXm4Ck",
            authDomain: "fluxocash-b81f6.firebaseapp.com",
            projectId: "fluxocash-b81f6",
            storageBucket: "fluxocash-b81f6.firebasestorage.app",
            messagingSenderId: "1021395240266",
            appId: "1:1021395240266:web:e44282819a1ab0c2feadb3"
        };
        const geminiApiKey = "AIzaSyCzz0ntyKDngm6Yae0OIbD0fXHakEXm4Ck";

        // SETUP
        let app, auth, db, currentUser = null;
        // Incomes: array of {id, desc, origin, value, date}
        // IncomeOrigins: array of strings
        let appData = { incomes: [], incomeOrigins: ['Sal√°rio', 'Freelance', 'Investimentos'], fixed: [], variable: [], debts: [], goals: [], budgets: [] }; 
        let isOffline = false;
        let chartRev=null, chartExp=null, chartInv=null, chartBal=null, chartBottle=null;
        let currentGoalId = null, currentGoalIndex = 0;

        const NEW_CATEGORIES = ['MORADIA','ALIMENTA√á√ÉO','MERCADO','SAUDE','LAZER','VIAGENS','COMPRAS','PRESENTES','OUTROS'];

        try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch(e) { console.error(e); }

        // UI HELPERS
        const ui = {
            screenAuth: document.getElementById('auth-screen'),
            screenApp: document.getElementById('app-screen'),
            msg: document.getElementById('auth-error'),
            setBtn: (id, loading) => {
                const btn = document.getElementById(id);
                btn.disabled = loading;
                btn.innerText = loading ? "..." : (btn.dataset.txt || btn.innerText);
                if(!btn.dataset.txt) btn.dataset.txt = btn.innerText;
            }
        };

        window.toggleAuth = (view) => {
            ui.msg.classList.add('hidden');
            document.getElementById('view-login').classList.toggle('hidden', view !== 'login');
            document.getElementById('view-register').classList.toggle('hidden', view !== 'register');
        };

        // AUTH + DATA LOGIC
        function showError(msg) {
            ui.msg.innerText = msg;
            ui.msg.classList.remove('hidden');
        }

        function handleAuthError(err, btnId) {
            ui.setBtn(btnId, false);
            console.error("Auth Error:", err);
            
            // Auto Fallback se API Bloqueada
            if(err.code && (err.code.includes('blocked') || err.code.includes('requests-to-this-api'))) {
                ui.msg.innerText = "Servidor inst√°vel. Entrando em modo offline seguro...";
                ui.msg.classList.remove('hidden');
                setTimeout(() => window.forceOfflineMode(), 1500);
            } else {
                showError("Erro: " + err.code);
            }
        }

        document.getElementById('form-login').onsubmit = async (e) => {
            e.preventDefault();
            ui.setBtn('btn-login', true);
            try { await signInWithEmailAndPassword(auth, document.getElementById('log-email').value, document.getElementById('log-pass').value); }
            catch(err) { handleAuthError(err, 'btn-login'); }
        };

        document.getElementById('form-register').onsubmit = async (e) => {
            e.preventDefault();
            const p1 = document.getElementById('reg-pass').value;
            const p2 = document.getElementById('reg-confirm').value;
            if(p1 !== p2) { showError("Senhas diferem"); return; }
            ui.setBtn('btn-reg', true);
            try { await createUserWithEmailAndPassword(auth, document.getElementById('reg-email').value, p1); }
            catch(err) { handleAuthError(err, 'btn-reg'); }
        };

        window.forceOfflineMode = () => {
            isOffline = true;
            ui.screenAuth.classList.add('hidden');
            ui.screenApp.classList.remove('hidden');
            ui.screenApp.classList.add('flex');
            document.getElementById('user-label').innerText = "Offline";
            document.getElementById('mode-badge').innerText = "Offline";
            document.getElementById('mode-badge').className = "text-[10px] bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full font-bold";
            const local = localStorage.getItem('fluxocash_local');
            if(local) {
                appData = JSON.parse(local);
            }
            checkMigration();
            render();
        };

        window.doLogout = () => { if(isOffline) location.reload(); else if(confirm("Sair?")) signOut(auth).then(()=>location.reload()); };

        if(auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    ui.screenAuth.classList.add('hidden');
                    ui.screenApp.classList.remove('hidden');
                    ui.screenApp.classList.add('flex');
                    document.getElementById('user-label').innerText = user.email || "Convidado";
                    document.getElementById('mode-badge').innerText = "Cloud";
                    const docRef = doc(db, 'artifacts', 'fluxocash-app', 'users', user.uid, 'app_data', 'main');
                    onSnapshot(docRef, (s) => {
                        if(s.exists()) {
                            appData = s.data();
                            checkMigration();
                        } else {
                            // First time defaults
                            appData = { incomes: [], incomeOrigins: ['Sal√°rio', 'Freelance'], fixed: [], variable: [], debts: [], goals: [], budgets: [] }; 
                            saveData();
                        }
                        render();
                    }, (err) => { 
                        // Fallback se leitura falhar
                        window.forceOfflineMode();
                    });
                }
            });
        }

        const saveData = async () => {
            if(isOffline) { localStorage.setItem('fluxocash_local', JSON.stringify(appData)); return; }
            if(currentUser) await setDoc(doc(db, 'artifacts', 'fluxocash-app', 'users', currentUser.uid, 'app_data', 'main'), appData);
        };
        
        function checkMigration() {
            // Se existia 'income' (numero) e n√£o 'incomes' (array), converte
            if(typeof appData.income === 'number' && (!appData.incomes || appData.incomes.length === 0) && appData.income > 0) {
                 appData.incomes = [{
                     id: Date.now(),
                     description: "Sal√°rio Antigo",
                     origin: "Sal√°rio",
                     value: appData.income,
                     date: new Date().toISOString().split('T')[0]
                 }];
                 delete appData.income; // Remove old field
            }
            if(!appData.incomes) appData.incomes = [];
            if(!appData.incomeOrigins) appData.incomeOrigins = ['Sal√°rio', 'Freelance', 'Investimentos'];
            
            // Ensure other arrays exist
            if(!appData.extraIncomes) appData.extraIncomes = []; 
            if(!appData.fixed) appData.fixed = []; 
            if(!appData.variable) appData.variable = []; 
            if(!appData.debts) appData.debts = []; 
            if(!appData.goals) appData.goals = []; 
            if(!appData.budgets) appData.budgets = [];
        }

        // --- IMPORTAR CSV (REFACTOR) ---
        window.importCSV = (input) => {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                let count = 0;

                lines.forEach(line => {
                    if(!line.trim()) return;
                    let cols = line.split(',');
                    if(cols.length < 3) cols = line.split(';');
                    if (cols.length >= 3) {
                        let rawDate = cols[0].trim();
                        let date = rawDate;
                        if(rawDate.includes('/') && rawDate.split('/').length === 3) {
                            const parts = rawDate.split('/');
                            date = `${parts[2]}-${parts[1]}-${parts[0]}`;
                        }
                        let title = cols[1].trim().replace(/"/g, '');
                        let rawVal = cols[2].trim();
                        let cleanVal = rawVal.replace(/[^\d.,-]/g, '');
                        if(cleanVal.includes(',') && !cleanVal.includes('.')) cleanVal = cleanVal.replace(',', '.');
                        else if(cleanVal.includes('.') && cleanVal.includes(',')) cleanVal = cleanVal.replace('.', '').replace(',', '.');
                        let val = parseFloat(cleanVal);
                        if (!isNaN(val)) {
                             val = Math.abs(val);
                             appData.variable.push({ name: title, category: 'OUTROS', subcategory: 'Importado', value: val, date: date, originalId: Date.now() });
                             count++;
                        }
                    }
                });
                alert(`${count} itens importados!`);
                saveData();
                render();
            };
            reader.readAsText(file);
        };

        // --- APP FUNCTIONS ---
        // INCOME FUNCTIONS
        window.addIncome = (e) => {
            e.preventDefault();
            const desc = document.getElementById('inc-desc').value;
            const origin = document.getElementById('inc-origin').value;
            const val = parseFloat(document.getElementById('inc-val').value);
            const date = document.getElementById('inc-date').value;
            
            if(desc && val && date) {
                // Add to list
                appData.incomes.push({
                    id: Date.now(),
                    description: desc,
                    origin: origin || 'Outros',
                    value: val,
                    date: date
                });
                
                // Add to origin list if new
                if(origin && !appData.incomeOrigins.includes(origin)) {
                    appData.incomeOrigins.push(origin);
                }
                
                e.target.reset();
                // Reset date to today
                document.getElementById('inc-date').valueAsDate = new Date();
                saveData();
                render();
            }
        };

        window.delIncome = (index) => {
            if(confirm("Remover receita?")) {
                appData.incomes.splice(index, 1);
                saveData();
                render();
            }
        };

        window.addFixed = (e) => { e.preventDefault(); const n=document.getElementById('fix-name').value, v=parseFloat(document.getElementById('fix-val').value); if(n&&v){ appData.fixed.push({name:n,value:v}); e.target.reset(); saveData(); } };
        window.addVar = (e) => { e.preventDefault(); const n=document.getElementById('var-desc').value, c=document.getElementById('var-cat').value,v=parseFloat(document.getElementById('var-val').value),d=document.getElementById('var-date').value;if(c&&v){appData.variable.push({category:c,value:v,date:d});document.getElementById('var-val').value=''; saveData(); } };
        window.addDebt = (e) => { e.preventDefault(); const n=document.getElementById('debt-name').value, t=parseFloat(document.getElementById('debt-tot').value)||0, p=parseFloat(document.getElementById('debt-par').value); if(n&&p){ appData.debts.push({name:n,total:t,parcel:p}); e.target.reset(); saveData(); } };
        window.addGoal = (e) => { e.preventDefault(); const n=document.getElementById('goal-name').value, v=parseFloat(document.getElementById('goal-val').value); if(n&&v){ appData.goals.push({name:n,value:v}); e.target.reset(); saveData(); } };
        window.addExtraIncome = (e) => { e.preventDefault(); const d=document.getElementById('extra-desc').value, v=parseFloat(document.getElementById('extra-val').value); if(d&&v){ if(!appData.extraIncomes) appData.extraIncomes=[]; appData.extraIncomes.push({desc:d,value:v}); e.target.reset(); saveData(); render(); } };

        window.delItem = (type, i) => { if(confirm("Remover?")) { appData[type].splice(i,1); saveData(); render(); } };
        window.delExtra = (i) => { if(confirm("Remover?")) { appData.extraIncomes.splice(i,1); saveData(); render(); } };
        window.resetAll = () => { if(confirm("Zerar?")) { appData={income:0,extraIncomes:[],fixed:[],variable:[],debts:[],goals:[],budgets:[]}; saveData(); render(); } };
        
        // NOVO: VARIABLE WITH INSTALLMENTS & SUBCAT
        window.addVar = (e) => {
            e.preventDefault();
            const desc = document.getElementById('var-desc').value;
            const cat = document.getElementById('var-cat').value;
            const sub = document.getElementById('var-sub').value || '';
            const val = parseFloat(document.getElementById('var-val').value);
            const dateStr = document.getElementById('var-date').value;
            const parc = parseInt(document.getElementById('var-parc').value) || 1;

            if(desc && val && dateStr) {
                const baseDate = new Date(dateStr);
                const valPerMonth = val / parc;

                for(let i=0; i<parc; i++) {
                    const d = new Date(baseDate);
                    d.setMonth(d.getMonth() + i);
                    const isoDate = d.toISOString().split('T')[0];
                    const label = parc > 1 ? `${desc} (${i+1}/${parc})` : desc;
                    
                    appData.variable.push({
                        name: label,
                        category: cat,
                        subcategory: sub,
                        value: valPerMonth,
                        date: isoDate,
                        originalId: Date.now() 
                    });
                }
                
                document.getElementById('var-desc').value = '';
                document.getElementById('var-val').value = '';
                document.getElementById('var-parc').value = '1';
                saveData();
                render();
            }
        };

        // --- RENDER ---
        function fmt(n) { return new Intl.NumberFormat('pt-BR', {style:'currency', currency:'BRL'}).format(n); }
        
        function render() {
            const monthlyData = getMonthlyData();
            const currentMonthIdx = new Date().getMonth();
            const currentData = monthlyData[currentMonthIdx];

            // RENDER INCOME ORIGINS DATALIST
            const dl = document.getElementById('origins-list');
            if(dl) {
                dl.innerHTML = '';
                (appData.incomeOrigins || []).forEach(org => {
                    const opt = document.createElement('option');
                    opt.value = org;
                    dl.appendChild(opt);
                });
            }

            // RENDER INCOME LIST (Current Month)
            const incomeList = document.getElementById('list-incomes-month');
            if(incomeList) {
                incomeList.innerHTML = '';
                const currentMonthIncomes = appData.incomes.filter(inc => {
                    const d = new Date(inc.date);
                    return d.getMonth() === currentMonthIdx && d.getFullYear() === new Date().getFullYear();
                });

                if(currentMonthIncomes.length === 0) {
                    incomeList.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-slate-400 italic">Nenhuma receita lan√ßada este m√™s.</td></tr>';
                } else {
                    currentMonthIncomes.forEach((inc) => {
                        // Find index in main array to delete
                        const globalIndex = appData.incomes.indexOf(inc);
                        incomeList.innerHTML += `
                            <tr class="border-b hover:bg-slate-50">
                                <td class="p-2 text-slate-500">${new Date(inc.date).toLocaleDateString('pt-BR')}</td>
                                <td class="p-2 font-bold text-slate-700">${inc.description}</td>
                                <td class="p-2 text-xs"><span class="bg-emerald-100 text-emerald-800 px-2 py-1 rounded-full">${inc.origin}</span></td>
                                <td class="p-2 text-right font-bold text-emerald-600">${fmt(inc.value)}</td>
                                <td class="p-2 text-center"><button onclick="delIncome(${globalIndex})" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></td>
                            </tr>
                        `;
                    });
                }
            }

            document.getElementById('dash-income').innerText = fmt(currentData.revenue);
            document.getElementById('dash-expense').innerText = fmt(currentData.expenses);
            const totalSaved = appData.goals.reduce((a,b) => a + (b.saved || 0), 0);
            document.getElementById('dash-invest').innerText = fmt(totalSaved);
            document.getElementById('dash-balance').innerText = fmt(currentData.accumulated); // Year Balance
            
            const lEx=document.getElementById('list-extra-incomes'); 
            if(lEx) { lEx.innerHTML=''; (appData.extraIncomes||[]).forEach((i,x)=>lEx.innerHTML+=`<li class="flex justify-between border-b pb-1 text-sm"><span>${i.desc}</span><div class="font-bold text-emerald-600">${fmt(i.value)} <button onclick="delExtra(${x})" class="text-red-400">x</button></div></li>`); }

            const lFix=document.getElementById('list-fixed'); lFix.innerHTML=''; appData.fixed.forEach((i,x)=>lFix.innerHTML+=`<tr class="border-b hover:bg-slate-50"><td class="p-3">${i.name}</td><td class="p-3 text-right">${fmt(i.value)}</td><td class="p-3 text-right"><button onclick="delItem('fixed',${x})" class="text-red-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`);

            const lVar=document.getElementById('list-variable'); lVar.innerHTML=''; 
            [...appData.variable].sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach((i,x)=>lVar.innerHTML+=`<li class="bg-white p-3 rounded border flex justify-between mb-2"><div><span class="font-bold block">${i.name} <small class="text-slate-400">(${i.subcategory||'-'})</small></span><span class="text-xs text-slate-500 bg-slate-100 px-1 rounded">${i.category}</span></div><div class="flex gap-2 font-bold text-orange-600"><span>${fmt(i.value)}</span><button onclick="delItem('variable',${x})" class="text-red-300 hover:text-red-500">x</button></div></li>`);

            const lDebt=document.getElementById('list-debts'); lDebt.innerHTML=''; 
            appData.debts.forEach((i,x)=> {
                // ... (existing debt logic) ...
                lDebt.innerHTML+=`<div class="bg-white p-3 rounded border-l-4 border-red-400 shadow-sm flex justify-between"><div><div class="font-bold">${i.name}</div><div class="text-xs">Total: ${fmt(i.totalValue)}</div></div><div class="text-right font-bold text-red-600">${fmt(i.installmentValue)} <button onclick="delItem('debts',${x})" class="ml-2 text-slate-300 hover:text-red-500">x</button></div></div>`;
            });

            // GOALS CAROUSEL & LIST
            const gFull = document.getElementById('list-goals-full'); if(gFull) gFull.innerHTML = '';
            appData.goals.forEach((g, idx) => {
                 if(gFull) gFull.innerHTML += `<div class="bg-white p-4 rounded border border-emerald-200"><div class="flex justify-between"><b>${g.name}</b><span>${fmt(g.saved)} / ${fmt(g.totalValue)}</span></div><div class="w-full bg-slate-100 h-2 rounded mt-2"><div class="bg-emerald-500 h-2 rounded" style="width:${(g.saved/g.totalValue)*100}%"></div></div><div class="flex justify-between mt-2"><button onclick="openAporte(${g.id})" class="text-xs bg-emerald-600 text-white px-2 py-1 rounded">Aportar</button><button onclick="deleteGoal(${idx})" class="text-xs text-red-400">Excluir</button></div></div>`;
            });
            renderGoalCarousel();

            // BUDGET RENDER
            const bList = document.getElementById('budget-list'); if(bList) {
                bList.innerHTML = '';
                NEW_CATEGORIES.forEach(cat => {
                    const lim = (appData.budgets||[]).find(b=>b.cat===cat)?.lim || 0;
                    const spent = appData.variable.filter(v=>v.category===cat && new Date(v.date).getMonth()===currentMonthIdx).reduce((a,b)=>a+b.value,0);
                    const pct = lim>0?(spent/lim)*100:0;
                    const col = pct>100?'bg-red-500':(pct>80?'bg-yellow-500':'bg-emerald-500');
                    bList.innerHTML += `<div class="bg-white p-3 rounded border"><div class="flex justify-between text-sm font-bold"><span>${cat}</span><span class="${pct>100?'text-red-600':''}">${fmt(spent)} / <input type="number" value="${lim}" onchange="updateBudgetLimit('${cat}',this.value)" class="w-20 text-right border-b outline-none"></span></div><div class="w-full bg-slate-100 h-2 mt-1"><div class="${col} h-2 rounded" style="width:${Math.min(pct,100)}%"></div></div></div>`;
                });
            }

            // --- CHARTS ---
            const ctxRev = document.getElementById('chart-revenue');
            if(ctxRev) {
                 if(chartRev) chartRev.destroy();
                 chartRev = new Chart(ctxRev.getContext('2d'), {
                     type: 'bar',
                     data: { labels: monthlyData.map(d=>d.month), datasets: [{ label: 'Receita', data: monthlyData.map(d=>d.revenue), backgroundColor: '#10b981' }] },
                     options: { responsive: true, maintainAspectRatio: false }
                 });
            }

            const ctxExp = document.getElementById('chart-expenses');
            if(ctxExp) {
                 const yearlyFixed = appData.fixed.reduce((a,b)=>a+b.value,0);
                 const fixedData = monthlyData.map(() => yearlyFixed); 
                 const varData = monthlyData.map(d => d.expenses - yearlyFixed); 
                 if(chartExp) chartExp.destroy();
                 chartExp = new Chart(ctxExp.getContext('2d'), {
                     type: 'bar',
                     data: { labels: monthlyData.map(d=>d.month), datasets: [{ label: 'Fixas', data: fixedData, backgroundColor: '#64748b' }, { label: 'Vari√°veis', data: varData, backgroundColor: '#f97316' }] },
                     options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } }
                 });
            }

            const ctxBot = document.getElementById('chart-bottlenecks');
            if(ctxBot) {
                 const catTotals = {};
                 appData.variable.filter(v=>new Date(v.date).getMonth()===currentMonthIdx).forEach(v => { catTotals[v.category] = (catTotals[v.category]||0)+v.value; });
                 if(chartBottle) chartBottle.destroy();
                 chartBottle = new Chart(ctxBot.getContext('2d'), {
                     type: 'doughnut',
                     data: { labels: Object.keys(catTotals), datasets: [{ data: Object.values(catTotals), backgroundColor: ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981', '#06b6d4', '#3b82f6', '#6366f1', '#a855f7'] }] },
                     options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } } }
                 });
            }

            const ctxBal = document.getElementById('chart-balance');
            if(ctxBal) {
                 if(chartBal) chartBal.destroy();
                 chartBal = new Chart(ctxBal.getContext('2d'), {
                     type: 'line',
                     data: { labels: monthlyData.map(d=>d.month), datasets: [{ label: 'Saldo Acumulado', data: monthlyData.map(d=>d.accumulated), borderColor: '#059669', fill: true, backgroundColor: 'rgba(16, 185, 129, 0.1)' }] },
                     options: { responsive: true, maintainAspectRatio: false }
                 });
            }
        }

        // --- HELPER: GROUP DATA BY MONTH ---
        function getMonthlyData() {
            const months = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
            const currentYear = new Date().getFullYear();
            const data = months.map(m => ({ month: m, revenue: 0, expenses: 0, balance: 0 }));
            
            // 1. Receitas: Sum incomes per month
            if (appData.incomes) {
                appData.incomes.forEach(inc => {
                    const d = new Date(inc.date);
                    if (d.getFullYear() === currentYear) {
                        data[d.getMonth()].revenue += inc.value;
                    }
                });
            }
            
            // 2. Despesas Fixas (Assume-se mensal)
            const yearlyFixed = appData.fixed.reduce((a,b)=>a+b.value,0);
            data.forEach(d => d.expenses += yearlyFixed);
            
            // 3. Despesas Vari√°veis
            appData.variable.forEach(v => {
                const date = new Date(v.date);
                if(date.getFullYear() === currentYear) {
                    data[date.getMonth()].expenses += v.value;
                }
            });

            // 4. Passivos
            const debtMonthly = appData.debts.reduce((a,b)=>a+b.installmentValue,0);
            data.forEach(d => d.expenses += debtMonthly);

            let accum = 0;
            data.forEach(d => {
                d.balance = d.revenue - d.expenses;
                accum += d.balance;
                d.accumulated = accum;
            });
            
            return data;
        }

        // CAROUSEL LOGIC
        function renderGoalCarousel() {
            const area = document.getElementById('goal-display-area');
            const goals = appData.goals;
            if(!goals || goals.length === 0) {
                document.getElementById('dash-goal-name').innerText = "Sem Metas";
                return;
            }
            if(currentGoalIndex >= goals.length) currentGoalIndex = 0;
            if(currentGoalIndex < 0) currentGoalIndex = goals.length - 1;
            
            const g = goals[currentGoalIndex];
            const pct = (g.saved / g.totalValue) * 100;
            document.getElementById('dash-goal-name').innerText = g.name;
            document.getElementById('dash-goal-missing').innerText = fmt(g.totalValue - g.saved);
            document.getElementById('dash-goal-bar').style.width = `${Math.min(pct,100)}%`;
            document.getElementById('dash-goal-pct').innerText = `${pct.toFixed(0)}% Conclu√≠do`;
            document.getElementById('goal-counter').innerText = `${currentGoalIndex+1}/${goals.length}`;
        }
        window.nextGoal = () => { currentGoalIndex++; renderGoalCarousel(); };
        window.prevGoal = () => { currentGoalIndex--; renderGoalCarousel(); };

        window.nav = (id) => { ['dashboard','fixed','variable','debts','goals','budget'].forEach(t => document.getElementById('page-'+t).classList.add('hidden')); document.getElementById('page-'+id).classList.remove('hidden'); if(id==='dashboard') render(); };
        window.closeAI = () => document.getElementById('ai-modal').classList.add('hidden');
        window.askAI = async (ctx) => { document.getElementById('ai-modal').classList.remove('hidden'); document.getElementById('ai-content').innerText = "Pensando..."; try { const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiApiKey}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({contents:[{parts:[{text:`Analise como Robert Kiyosaki. Dados: ${JSON.stringify(appData)}. Foco: ${ctx}. Markdown.`}]}]}) }); const d = await res.json(); document.getElementById('ai-content').innerHTML = marked.parse(d.candidates[0].content.parts[0].text); } catch(e) { document.getElementById('ai-content').innerText = "Erro IA"; } };

        document.getElementById('inc-date').valueAsDate = new Date();
        document.getElementById('var-date').valueAsDate = new Date();
    </script>
</body>
</html>
